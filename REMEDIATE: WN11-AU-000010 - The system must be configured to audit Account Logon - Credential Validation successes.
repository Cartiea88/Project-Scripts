# Enable-AuditCredentialValidation.ps1
#
# Remediation script for STIG WN11-AU-000010: Audit Credential Validation (success).
#
# This script enables auditing of successful credential validation events via the
# Windows advanced audit policy. According to the STIG, systems must audit
# Credential Validation successes so that authentication attempts are recorded
# for forensic and incident response purposes. The associated registry and
# Group Policy settings correspond to the "Audit Credential Validation" subcategory
# under the Account Logon audit category. Running this script will configure
# the local audit policy using the `auditpol` command-line utility.
#
# References:
# - DISA STIG WN11-AU-000010: The system must audit Credential Validation successes. It
#   explains that the policy value for `Audit Credential Validation` must be
#   configured to "Success" and provides remediation steps via Group Policy【725149356049368†L25-L45】.
# - Microsoft documentation for auditpol: using the `/set /subcategory` switches
#   allows enabling success or failure auditing for a given subcategory. Specifying
#   `/success:enable` enables success auditing while leaving other options unchanged【625739899832175†L522-L598】.
# - Example of using auditpol to set audit policy subcategories from a security
#   best practices guide【554687056478206†L147-L151】.

<#
.SYNOPSIS
    Enables auditing for Credential Validation successes.

.DESCRIPTION
    This script configures the advanced audit policy so that the "Credential Validation" audit
    subcategory logs successful events. It requires administrative privileges to run.
    The script checks for administrative rights, and if not present, displays an error.
    It then invokes `auditpol.exe` with the appropriate parameters to enable success
    auditing for the Credential Validation subcategory. After running, it outputs
    the current status of the subcategory to verify that the setting applied correctly.

.NOTES
    Author          : Christopher Danley
    LinkedIn        : www.linkedin.com/in/christopherdanley
    GitHub          : github.com/Cartiea88
    Date Created    : 1/14/26
    Last Modified   : 1/14/26
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN11-AU-000010

.EXAMPLE
    PS C:\> .\Enable-AuditCredentialValidation.ps1
    Ensures Credential Validation successes are audited.
#>

function Assert-Admin {
    <#
    .SYNOPSIS
        Checks whether the script is running with administrative privileges.
    .OUTPUTS
        None. Throws an exception if not running as admin.
    #>
    $currentIdentity = [System.Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object System.Security.Principal.WindowsPrincipal($currentIdentity)
    if (-not $principal.IsInRole([System.Security.Principal.WindowsBuiltinRole]::Administrator)) {
        throw "This script must be run with administrative privileges."
    }
}

try {
    # Ensure the script is executed as administrator
    Assert-Admin

    Write-Host "Configuring audit policy for Credential Validation..." -ForegroundColor Cyan

    # Use auditpol to set success auditing for Credential Validation
    # /success:enable enables success auditing; failure settings remain unchanged【625739899832175†L522-L598】.
    $auditResult = & auditpol.exe /set /subcategory:"Credential Validation" /success:enable 2>&1
    if ($LASTEXITCODE -ne 0) {
        Write-Warning "Audit policy configuration may have failed. Output:"
        Write-Warning $auditResult
    }

    # Display current audit policy status for Credential Validation
    Write-Host "Retrieving current audit policy for 'Credential Validation'..." -ForegroundColor Cyan
    $currentPolicy = & auditpol.exe /get /subcategory:"Credential Validation" /r
    Write-Host $currentPolicy

    Write-Host "Audit policy configuration completed." -ForegroundColor Green
} catch {
    Write-Error $_.Exception.Message
}
