# Disable-AlwaysInstallElevated.ps1
#
# This script remediates STIG finding WN11‑CC‑000315 by disabling the
# "Always install with elevated privileges" Windows Installer feature.
# The STIG requires that the registry value `AlwaysInstallElevated` be set
# to `0` (REG_DWORD) in the per‑machine policy under
# `HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer`【104265902097321†L19-L36】.  Setting
# the policy to `Disabled` prevents standard users from installing MSI
# packages with system‑level privileges, which would otherwise pose a
# serious security risk【104265902097321†L19-L36】.

<#
 .SYNOPSIS
    Disables the Windows Installer "Always install with elevated privileges" feature.

 .DESCRIPTION
    This script enforces the STIG requirement WN11‑CC‑000315 by ensuring that
    the registry key for the Windows Installer policy does not enable
    elevated privileges.  It does the following:

    - Checks for administrative privileges, exiting if they are missing.
    - Creates the per‑machine policy path if it doesn’t exist.
    - Sets the `AlwaysInstallElevated` value to `0` (REG_DWORD) under
      `HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer`【104265902097321†L19-L36】.
    - Optionally also creates/sets the same value under the per‑user path
      `HKCU:\SOFTWARE\Policies\Microsoft\Windows\Installer` so that any
      user‑level setting does not override the machine policy.  Although the
      STIG requirement only specifies the machine policy, setting both keys
      reinforces the security posture.

    When complete, the script prints the resulting registry values so you can
    verify the changes.

.NOTES
    Author          : Christopher Danley
    LinkedIn        : www.linkedin.com/in/christopherdanley
    GitHub          : github.com/Cartiea88
    Date Created    : 1/14/26
    Last Modified   : 1/14/26
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN11-SO-000070
#>

function Assert-Admin {
    # Verifies the script is running as an administrator.
    $currentIdentity = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentIdentity)
    if (-not $principal.IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
        Write-Error "This script must be run with administrative privileges." -ErrorAction Stop
    }
}

try {
    Assert-Admin

    # Define registry paths for machine and user policies
    $hkLMPath = 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer'
    $hkCUPath = 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\Installer'

    # Ensure the machine policy key exists
    if (-not (Test-Path -Path $hkLMPath)) {
        New-Item -Path $hkLMPath -Force | Out-Null
    }

    # Set the machine policy value to 0 (Disabled)
    Set-ItemProperty -Path $hkLMPath -Name 'AlwaysInstallElevated' -Value 0 -Type DWord
    Write-Host "Set HKLM AlwaysInstallElevated to 0 (Disabled)."

    # Optional: also set the per‑user policy to 0 to ensure it is not enabled
    if (-not (Test-Path -Path $hkCUPath)) {
        New-Item -Path $hkCUPath -Force | Out-Null
    }
    Set-ItemProperty -Path $hkCUPath -Name 'AlwaysInstallElevated' -Value 0 -Type DWord
    Write-Host "Set HKCU AlwaysInstallElevated to 0 (Disabled)."

    # Display the resulting values for verification
    $machineValue = (Get-ItemProperty -Path $hkLMPath -Name 'AlwaysInstallElevated').AlwaysInstallElevated
    $userValue    = (Get-ItemProperty -Path $hkCUPath -Name 'AlwaysInstallElevated').AlwaysInstallElevated
    Write-Host "Resulting HKLM value: $machineValue"
    Write-Host "Resulting HKCU value: $userValue"

    Write-Host "Always install with elevated privileges has been disabled successfully."

} catch {
    Write-Error "Failed to disable Always install with elevated privileges: $_"
}
